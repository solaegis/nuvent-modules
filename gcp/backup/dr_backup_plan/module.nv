#------------------------------------------------------------------------------
# gcp/backup/dr_backup_plan/module.nv
# yaml-language-server: $schema=https://raw.githubusercontent.com/solaegis/nuvent/refs/heads/main/tools/vscode-extension/schemas/nuvent-manifest.schema.json
#------------------------------------------------------------------------------

variables:
  backup_plan_id:
    type: string
    description: "The ID of the backup plan"
  backup_vault:
    type: string
    description: "Backup vault where the backups gets stored using this Backup plan."
  location:
    type: string
    description: "The location for the backup plan"
  resource_type:
    type: string
    description: "The resource type to which the 'BackupPlan' will be applied. Examples include, \"compute.googleapis.com/Instance\", \"compute.googleapis.com/Disk\", \"sqladmin.googleapis.com/Instance\" and \"storage.googleapis.com/Bucket\"."
  description:
    type: string
    description: "The description allows for additional details about 'BackupPlan' and its use cases to be provided."
    default: null
  id:
    type: string
    description: "Optional property for DrBackupPlan"
    default: null
  log_retention_days:
    type: number
    description: "This is only applicable for CloudSql resource. Days for which logs will be stored. This value should be greater than or equal to minimum enforced log retention duration of the backup vault."
    default: null
  project:
    type: string
    description: "Optional property for DrBackupPlan"
    default: null
  backup_rules:
    type: list
    description: "Nested block: backup_rules"
    default: []
  timeouts:
    type: list
    description: "Nested block: timeouts"
    default: []

resources:
  main:
    type: gcp:backup:DrBackupPlan
    properties:
      backup_plan_id: ${var.backup_plan_id}
      backup_vault: ${var.backup_vault}
      location: ${var.location}
      resource_type: ${var.resource_type}
      description: ${var.description}
      id: ${var.id}
      log_retention_days: ${var.log_retention_days}
      project: ${var.project}
      dynamic:
        backup_rules:
          for_each: ${var.backup_rules}
          content:
            backup_retention_days: ${each.value.backup_retention_days}
            rule_id: ${each.value.rule_id}
            standard_schedule: ${each.value.standard_schedule}
        timeouts:
          for_each: ${var.timeouts}
          content:
            create: ${each.value.create}
            delete: ${each.value.delete}
            update: ${each.value.update}

outputs:
  backup_vault_service_account:
    description: "The Google Cloud Platform Service Account to be used by the BackupVault for taking backups."
    value: ${resources.main.backup_vault_service_account}
  create_time:
    description: "When the 'BackupPlan' was created."
    value: ${resources.main.create_time}
  id:
    description: "Output: id"
    value: ${resources.main.id}
  name:
    description: "The name of backup plan resource created"
    value: ${resources.main.name}
  project:
    description: "Output: project"
    value: ${resources.main.project}
  supported_resource_types:
    description: "The list of all resource types to which the 'BackupPlan' can be applied."
    value: ${resources.main.supported_resource_types}
  update_time:
    description: "When the 'BackupPlan' was last updated."
    value: ${resources.main.update_time}
